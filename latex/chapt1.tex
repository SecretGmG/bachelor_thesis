\chapter{Triangle Integral}
The goal of this chapter is to apply Threshold subtraction to the triangle integral where the mass $m$ is complex, to show that the core ideas of threshold subtraction generalize.
We will restrict ourselves to masses where $\Re(m^2) > 0$ and $\Im{m^2} \leq 0$ as it will make the signs and evaluations of square roots simpler.
The procedure we want to describe is shown in figure~\ref{fig:triangle_feynman}, the corresponding integral is given in Eq.~\eqref{eq:triangle_integral}.

\begin{figure}[H]
    \centering
    \input{assets/diagrams/traingle.tex}
   \caption{Feynman diagram of the Triangle loop integral}\label{fig:triangle_feynman}
\end{figure}

\begin{equation}
    I = \int \frac{\dd[4]{k}}{{(2\pi)}^4} \frac{i}{D_1D_2D_3} \label{eq:triangle_integral}
\end{equation}
with
\begin{equation}
    D_i = {(\vb{k}-\vb{q}_i)}^2-m^2+i\varepsilon \label{eq:denom}
\end{equation}.
and
\begin{align}
    \vb{q}_1 = \vb{0}           \\
    \vb{q}_2 = - \vb{p}_1 \\
    \vb{q}_3 = \vb{p}_2
\end{align}

\section{Loop Tree Duality}
We will perform the $k^0$ integration with the cauchy theorem.
For this we need to consider the poles of the integrand from Eq.~\eqref{eq:triangle_integral} in $k^0$. These are found to
be the following.
\begin{equation}
    k^0 = q_i^0 \pm \qty(\sqrt{{\qty(\va{k}-\va{q}_i)}^2+m^2}-i\varepsilon) = q_i^0 \pm \qty(E_i - i\varepsilon)
\end{equation}
We will arbitrarily decide to close the contour around the poles corresponding to the principal square roots.
Notice that the principal square root preserves the sign of the imaginary part of the argument. 
Thus we need to close the contour below. This contour is shown in Figure~\ref{fig:poles}.
\begin{figure}[H]
    \centering
    \input{assets/diagrams/poles.tex}
    \caption{Poles of the denominator}\label{fig:poles}
\end{figure}

We can now apply cauchy's theorem to perform the $k^0$ integral.
\begin{equation}
    I = \int \frac{\dd[3]{k}}{{(2\pi)}^4} 2\pi i \sum_{i= 1}^{3} \On{Res}_{k^0 = q^0_i + E_i}\qty[\frac{i}{D_1D_2D_3}] \label{eq:cauchy}
\end{equation}

Let's compute the residues.
\begin{equation}
    \On{Res}_{k^0 = q^0_i + E_i}\qty[\frac{i}{D_1D_2D_3}] = {\qty[\frac{i}{D_i'}\prod_{\neq j} \frac{1}{D_j}]}_{k^0=E_i}= \frac{i}{2E_i} \prod_{i\neq j} \eval{\frac{1}{D_j}}_{k^0=E_i} \label{eq:residue}
\end{equation}

\newcommand{\ELIPT}[2]{\eta_{#1#2}^{++}}
\newcommand{\HYPER}[2]{\eta_{#1#2}^{+-}}

We can also introduce $\ELIPT{i}{j}$ called E-Surface and $\HYPER{i}{j}$ called H-Surface to simplify the algebra.

\begin{align}
    \eval{D_j}_{k^0=E_i} &= {\qty(q^0_i+E_i-q^0_j)}^2 - \overbrace{{\qty(\va{k}-\va{q}_j)}^2+m^2}^{E_j^2}\\
    &= E_i^2+{q_i^0}^2+{q_j^0}^2-2q_i^0q_j^0+2q_i^0E_i - 2q_j^0E_i-E_j^2\\
    &= \underbrace{\left(E_i+E_j+q_i^0-q_j^0\right)}_{\ELIPT{i}{j}}\underbrace{\left(E_i-E_j+q_i^0-q_j^0\right)}_{\HYPER{i}{j}} \label{eq:surfaces}
\end{align}
Inserting the results from Eq.~\eqref{eq:surfaces} and Eq.~\eqref{eq:residue} into Eq.~\eqref{eq:cauchy} we get the Loop Tree duality expression.
\newcommand{\BLTD}[3]{2E_{#1}\ELIPT{#1}{#2}\HYPER{#1}{#2}\ELIPT{#1}{#3}\HYPER{#1}{#3}}
\begin{equation}
    I =  \int \frac{\dd[3]{k}}{{(2\pi)}^3}\qty(\frac{1}{\BLTD{1}{2}{3}}+\frac{1}{\BLTD{2}{1}{3}}+\frac{1}{\BLTD{3}{1}{2}}) \label{eq:naive_ltd}
\end{equation}

While this is a nice expression, it is not yet suited for numeric integration, since all of the H-Surfaces contain singularities which would make the procedure numerically unstable. It turns out however that these singularities are spurious and can be removed by purely algebraic manipulations, shown in detail in Appendix~\ref{sec:improved_ltd}. The resulting expression contains only E-Surfaces.

\begin{equation}
    I
    =  \int \frac{\dd[3]{k}}{{(4\pi)}^3} \frac{1}{E_1E_2E_3} \qty(
    \frac{1}{\ELIPT{2}{1}\ELIPT{3}{1}}
    + \frac{1}{\ELIPT{1}{2}\ELIPT{1}{3}}
    + \frac{1}{\ELIPT{1}{2}\ELIPT{3}{2}}
    + \frac{1}{\ELIPT{2}{1}\ELIPT{2}{3}}
    + \frac{1}{\ELIPT{1}{3}\ELIPT{2}{3}}
    + \frac{1}{\ELIPT{3}{1}\ELIPT{3}{2}}
    )
\label{eq:improved_ltd}
\end{equation}

\section{E-Surfaces}
The E-Surfaces themselves may still have singularities. We will now study them more closely.
Let us consider the problem in hemispherical coordinates centered around $\va{k_0}$. We also introduce $\va{k'}$ to simplify the algebra.
\begin{equation}
\va{k} = k \, \hat{\vb{k}} + \va{k_0} = \underbrace{k \, \hat{\vb{k}} + \va{k'_0}}_{\va{k'}} - \frac{1}{2}(\va{q}_i+\va{q}_j)
\end{equation}
Defining $\vb{q} = \frac{1}{2}\qty(\vb{q}_i-\vb{q}_j)$, the E-Surface simplifies to the following form.
\begin{equation}
    \ELIPT{i}{j} =  \sqrt{{(\va{k'}-\va{q})}^2+m^2} + \sqrt{{(\va{k'}+\va{q})}^2+m^2} + 2q^0 \overset{!}{=} 0
\end{equation}
Notice that if $q^0 > 0$ there cannot be any solutions, otherwise the square roots of the E-Surface can be eliminated by considering the following.
\begin{align}
    \sqrt{A}+\sqrt{B} &= C\\
    \implies\quad 2\sqrt{AB} &= C^2-A-B\\
    \implies\quad 4AB &= {(C^2-A-B)}^2
\end{align}
When we now insert and simplify, we get the following expression characterizing the E-surface.
\begin{equation}
    {\va{k'}}^2 - {\qty(\va{k'}\cdot\va{v})}^2 = \vb{q}^2-m^2 \qquad \text{with} \qquad \va{v} = \frac{\va{q}}{q^0}
\end{equation}
By inserting the parametrization we can then solve for the solutions in the radius $k$.
\begin{equation}
    {\qty(k \, \hat{\vb{k}} + \va{k'_0})}^2 - {\qty((k \, \hat{\vb{k}} + \va{k'_0})\cdot \va{v})}^2 = \vb{q}^2-m^2
\end{equation}
We find the following second order polynomial.
\begin{equation}
    \qty[1-\hat{\vb{k}} \cdot \va{v}] k^2 +  2 \qty[\hat{\vb{k}} \cdot \va{k'_0} - \qty(\hat{\vb{k}} \cdot \va{v})\qty(\va{k'_0} \cdot \va{v})]\, k + \qty[\va{k_0}^2 - {\qty(\va{k'_0} \cdot \va{v})} - \vb{q}^2 + m^2] = 0 \label{eq:e_surface_quad}
\end{equation}
The geometry of the E-surface is made more apparent when choosing the parametrization center such that $\va{k'_0} = \va{0}$. In this case the expression above can simplify to the following well known parametrization of an ellipsoid.
\begin{equation}
    k^2 = \frac{\vb{q}^2-m^2}{1-{\qty(\hat{\vb{k}} \cdot \va{v})}^2}
\end{equation}
\section{Threshold subtraction}
local cancellation etc.
\subsection{Subtraction of a single E-Surface}
Let's define a counterterm to subtract the E-surface pole from an integrand $\mathcal{I}$ of the form
\begin{equation}
    \mathcal{I} = \frac{f(\va{k})}{\ELIPT{i}{j}}
\end{equation}
where we parameterize the space hemispherically with the center $\va{k}_0$ chosen inside of the ellipsoid.
The zeros along the radius can then be found with Eq.~\eqref{eq:e_surface_quad}.
We will always find two solutions, which we will call $k^*_1$ and $k^*_2$.

Let us Taylor expand $\ELIPT{i}{j}$ to the first order in $k$ around the zero $k^*_i$, also define $\va{k^*_i} = k^*\,\hat{\vb{k}} +\va{k_0}$
\begin{equation}
    \ELIPT{i}{j} = 0 + (k-k^*) \underbrace{\eval{\pdv{k} \ELIPT{i}{j}}_{\va{k}=\va{k}^*}}_{\eta'} + \order{k^2}
\end{equation}
We can now define the form of our counterterm that will cancel the singularity in $k^*$.
\begin{equation}
    \on{CT} = \chi (\va{k}) \frac{f(\va{k^*_i})}{(k-k^*)\eta'}
\end{equation}
where $\chi (\va{k})$ is an arbitrary mask, that is smooth at $\chi (\va{k}^*) = 1$
The partial derivative is easy to compute
\begin{equation}
    \eval{\pdv{k} \ELIPT{i}{j}}_{\va{k}=k \hat{\vb{k}} } = {\qty[\frac{1}{E_i}(\va{k}-\va{q}_i)\cdot \hat{\vb{k}} + \frac{1}{E_j}(\va{k}-\va{q}_j)\cdot \hat{\vb{k}} ]}_{\va{k} = \va{k}^*}
\end{equation}

\subsection{Radially integrating the counterterm}
The choice of the mask $\chi$ is important to ensure, that the analytical integration over the pole in the counterterm is feasible.
The integral of the counterterm can be written in hemispherical coordinates centered around $\va{k_0}$.

\begin{equation}
    I_{\on{CT}} = \int_{S^2} \dd[2]{\hat{\vb{k}} } \int_{0}^{\infty} \dd{k} {k}^2 \on{CT}(\vec{k})
\end{equation}

We can now notice some interesting things about the choice of $\chi$.
\begin{itemize}
    \item We can remove the jacobian $k^2$ by choosing $\chi = \frac{{k^*}^2}{k^2}$.
    \item If $\chi = \frac{{k^*}^2}{k^2} f(k)$ where $f$ is an even function, the real part of the integration will be identically $0$  
\end{itemize}
Notice however that if we choose to eliminate the jacobian in this way we must ensure that either, the parametrization of the subtracted integrand has the same jacobian or that we include some other factors that ensure that $\chi$ stays finite as $k \to 0$.

In our case we will choose the following mask $\chi$.
\begin{equation}
    \chi{\va{k}} = \begin{cases}
        \frac{{k^*}^2}{k^2} & k \in (\lambda_1, \lambda_2)\\
        0& \text{else}
    \end{cases}
\end{equation}
The radial integration is now easy to compute
\begin{equation}
    I_{CT, R} = \int_{\lambda_1}^{\lambda_2} \dd{k} \frac{1}{k-k^*} = \ln(\frac{\lambda_2-k^*}{\lambda_1-k^*})
\end{equation}
Let's consider the special case where $\lambda_1 = \Re k^* - \lambda$ and $\lambda_2 = \Re k^* + \lambda$.
Then the real part of this integration is always zero because $\abs{\lambda-i\Im k^*} = \abs{-\lambda-i\Im k^*}$, we find.
\begin{equation}
    I_{CT, R} =  -i\qty(\pi + 2\atan(\frac{\Im k^*}{\lambda}))
\end{equation}
In this result we recover the original TODO.
\begin{equation}
    I_{CT} = -i\int_{S^2} \dd[2]{\hat{\vb{k}} } N(\hat{\vb{k}} ) I_{CT, R}
\end{equation}

\subsubsection{Threshold subtraction in the actual integrand}
To simplify we choose a single center, for the integration


\subsection{Results}

Plots for threshold subtraction.

Plots of numerical stability with relative error (dimensionless)